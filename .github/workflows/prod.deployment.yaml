on:
    push:
        tags:
            - '[0-9]+.[0-9]+.[0-9]+'

name: Deploy Application
jobs:
    set-version-tags:
        name: Set version tags
        runs-on: ubuntu-latest
        outputs:
            version: ${{ steps.prepare-version-tags.outputs.version }}
            tags: ${{ steps.prepare-version-tags.outputs.tags }}
            rc-version: ${{ steps.prepare-version-tags.outputs.rc-version }}
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
            - name: Prepare image version and tags
              id: prepare-version-tags
              run: |
                  DOCKER_IMAGE=derp
                  VERSION=${GITHUB_REF#refs/tags/}
                  VERSION=${VERSION//\//-}
                  TAGS="${DOCKER_IMAGE}:${VERSION}"

                  MINOR=${VERSION%.*}
                  MAJOR=${MINOR%.*}
                  TAGS="$TAGS,${DOCKER_IMAGE}:${MINOR},${DOCKER_IMAGE}:${MAJOR},${DOCKER_IMAGE}:latest"

                  git fetch --tags
                  
                  echo "rc-version=$(git tag --list "${VERSION}-rc.*" | tail -1)" >> $GITHUB_OUTPUT
                  echo "version=${VERSION}" >> $GITHUB_OUTPUT
                  echo "tags=${TAGS}" >> $GITHUB_OUTPUT

    deploy-prod:
        name: Retag and Deploy to Production
        runs-on: ubuntu-latest
        needs:
            - set-version-tags
        steps:
            - run: echo ${{ needs.set-version-tags.outputs.version }}
            - run: echo ${{ needs.set-version-tags.outputs.rc-version }}
